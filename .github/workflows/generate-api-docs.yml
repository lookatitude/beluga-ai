name: Generate API Documentation

on:
  push:
    branches:
      - main
    paths:
      - 'pkg/**/*.go'
      - 'scripts/generate-docs.sh'
      - '.github/workflows/generate-api-docs.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'pkg/**/*.go'
      - 'scripts/generate-docs.sh'
  workflow_dispatch:

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'

      - name: Install gomarkdoc
        run: |
          go install github.com/princjef/gomarkdoc/cmd/gomarkdoc@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Install Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'

      - name: Generate API documentation
        run: |
          bash scripts/generate-docs.sh

      - name: Validate generated documentation
        run: |
          bash scripts/validate-godoc-output.sh

      - name: Check for documentation changes
        id: check-changes
        run: |
          # Check if generated files differ from what's committed in the PR branch
          # This ensures the PR has the latest generated documentation
          # Use diff to check for actual content changes, ignoring whitespace
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PRs, check if there are significant differences (not just whitespace)
            # Count non-whitespace-only changes
            changes=$(git diff --ignore-all-space --ignore-blank-lines --name-only HEAD -- website/docs/api/packages/ 2>/dev/null | wc -l || echo "0")
            if [ "$changes" -gt 0 ]; then
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "Detected $changes file(s) with content changes"
              git diff --stat --ignore-all-space --ignore-blank-lines HEAD -- website/docs/api/packages/ || true
            else
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "No significant content changes detected"
            fi
          else
            # For push events, use standard git status check
            if [ -n "$(git status --porcelain website/docs/api/packages)" ]; then
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "Detected changes in generated documentation files"
              git status --short website/docs/api/packages/ || true
            else
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "No changes detected - documentation is up to date"
            fi
          fi

      - name: Commit and push changes (main branch only)
        if: github.ref == 'refs/heads/main' && steps.check-changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add website/docs/api/packages/
          git commit -m "docs: auto-generate API documentation [skip ci]" || exit 0
          git push

      - name: Warn if docs are outdated (PR only)
        if: github.event_name == 'pull_request' && steps.check-changes.outputs.has_changes == 'true'
        run: |
          echo "::warning::API documentation may be out of date. Generated files differ from committed files."
          echo "This may be due to gomarkdoc version differences or formatting changes."
          echo "For the initial documentation PR, this is expected. After merge, docs will auto-update on main."
          echo ""
          echo "To update manually, run: bash scripts/generate-docs.sh"
          # Don't fail - this is expected for initial PR with new documentation feature
          # After merge to main, the workflow will auto-commit updated docs
