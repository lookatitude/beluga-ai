name: Coverage Report

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  coverage:
    name: Generate Coverage Report
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for coverage comparison

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'
          cache-dependency-path: go.sum

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-coverage-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-coverage-

      - name: Generate coverage report
        run: |
          mkdir -p coverage
          go test -coverprofile=coverage/coverage.out -covermode=atomic ./...
          go tool cover -html=coverage/coverage.out -o coverage/coverage.html

      - name: Generate coverage summary
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          go tool cover -func=coverage/coverage.out >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          TOTAL_COVERAGE=$(go tool cover -func=coverage/coverage.out | tail -1 | awk '{print $3}')
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Total Coverage: $TOTAL_COVERAGE" >> $GITHUB_STEP_SUMMARY

      - name: Upload coverage HTML
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: coverage/coverage.html
          retention-days: 30

      - name: Upload coverage data
        uses: actions/upload-artifact@v4
        with:
          name: coverage-data
          path: coverage/coverage.out
          retention-days: 30

      # Optional: Upload to Codecov (uncomment if using Codecov)
      # - name: Upload to Codecov
      #   uses: codecov/codecov-action@v4
      #   with:
      #     file: ./coverage/coverage.out
      #     flags: unittests
      #     name: codecov-umbrella
      #     fail_ci_if_error: false

      # Comment coverage on PR
      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          message: |
            ## ðŸ“Š Coverage Report
            
            Total coverage: **${{ github.run_number }}**
            
            View detailed coverage report in the workflow artifacts.
            
            ### Coverage Summary
            ```
            ${{ github.run_id }}
            ```
            
            Run `make test-coverage` locally to generate an HTML report.

