name: Security Checks

on:
  workflow_call:
    secrets:
      SNYK_TOKEN:
        required: false
      GITLEAKS_LICENSE:
        required: false
    outputs:
      snyk_status:
        description: "Snyk scan status"
        value: ${{ jobs.snyk.outputs.snyk_status }}
      snyk_vulns:
        description: "Number of Snyk vulnerabilities"
        value: ${{ jobs.snyk.outputs.snyk_vulns }}
      trivy_status:
        description: "Trivy scan status"
        value: ${{ jobs.trivy.outputs.trivy_status }}
      trivy_findings:
        description: "Number of Trivy findings"
        value: ${{ jobs.trivy.outputs.trivy_findings }}
      govulncheck_status:
        description: "govulncheck scan status"
        value: ${{ jobs.govulncheck.outputs.govulncheck_status }}
      govulncheck_vulns:
        description: "Number of govulncheck vulnerabilities"
        value: ${{ jobs.govulncheck.outputs.govulncheck_vulns }}
      gosec_status:
        description: "gosec scan status"
        value: ${{ jobs.gosec.outputs.gosec_status }}
      gitleaks_status:
        description: "Gitleaks scan status"
        value: ${{ jobs.gitleaks.outputs.gitleaks_status }}
      licenses_status:
        description: "License compliance status"
        value: ${{ jobs.go-licenses.outputs.licenses_status }}
      licenses_violations:
        description: "Number of license violations"
        value: ${{ jobs.go-licenses.outputs.licenses_violations }}
  schedule:
    - cron: "0 4 * * 1" # Weekly Monday 4am UTC

env:
  GO_VERSION: "1.25.7"

jobs:
  snyk:
    name: Snyk Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      snyk_status: ${{ steps.snyk_result.outputs.status }}
      snyk_vulns: ${{ steps.snyk_result.outputs.vulns }}
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run Snyk
        id: snyk_scan
        uses: snyk/actions/golang@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --json-file-output=snyk-report.json

      - name: Parse Snyk results
        id: snyk_result
        if: always()
        run: |
          if [ "${{ steps.snyk_scan.outcome }}" = "success" ]; then
            echo "status=clean" >> $GITHUB_OUTPUT
            echo "vulns=0" >> $GITHUB_OUTPUT
          else
            VULNS=$(jq '.vulnerabilities | length // 0' snyk-report.json 2>/dev/null || echo "unknown")
            echo "status=vulnerabilities-found" >> $GITHUB_OUTPUT
            echo "vulns=${VULNS}" >> $GITHUB_OUTPUT
          fi

  trivy:
    name: Trivy Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    outputs:
      trivy_status: ${{ steps.trivy_result.outputs.status }}
      trivy_findings: ${{ steps.trivy_result.outputs.findings }}
    steps:
      - uses: actions/checkout@v6

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"

      - name: Upload Trivy SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: "trivy-results.sarif"
          category: "trivy"

      - name: Parse Trivy results
        id: trivy_result
        if: always()
        run: |
          if [ -f trivy-results.sarif ]; then
            FINDINGS=$(jq '[.runs[].results[]] | length // 0' trivy-results.sarif 2>/dev/null || echo "0")
          else
            FINDINGS=0
          fi
          if [ "$FINDINGS" -gt 0 ]; then
            echo "status=findings-detected" >> $GITHUB_OUTPUT
          else
            echo "status=clean" >> $GITHUB_OUTPUT
          fi
          echo "findings=${FINDINGS}" >> $GITHUB_OUTPUT

      - name: Upload Trivy SARIF artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-sarif
          path: trivy-results.sarif

  gitleaks:
    name: Gitleaks Secret Detection
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      gitleaks_status: ${{ steps.gitleaks_result.outputs.status }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        id: gitleaks_scan
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Set Gitleaks status
        id: gitleaks_result
        if: always()
        run: |
          if [ "${{ steps.gitleaks_scan.outcome }}" = "success" ]; then
            echo "status=clean" >> $GITHUB_OUTPUT
          else
            echo "status=secrets-detected" >> $GITHUB_OUTPUT
          fi

  go-licenses:
    name: License Compliance
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      licenses_status: ${{ steps.licenses_result.outputs.status }}
      licenses_violations: ${{ steps.licenses_result.outputs.violations }}
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install go-licenses
        run: go install github.com/google/go-licenses@latest

      - name: Check license compliance
        id: license_check
        continue-on-error: true
        run: |
          go-licenses check ./... \
            --allowed_licenses=MIT,Apache-2.0,BSD-2-Clause,BSD-3-Clause,ISC,MPL-2.0 \
            2> license-errors.txt || true

      - name: Generate license inventory
        run: |
          go-licenses csv ./... > licenses.csv 2>/dev/null || true

      - name: Parse license results
        id: licenses_result
        if: always()
        run: |
          if [ -s license-errors.txt ]; then
            VIOLATIONS=$(wc -l < license-errors.txt | tr -d ' ')
            echo "status=violations-found" >> $GITHUB_OUTPUT
            echo "violations=${VIOLATIONS}" >> $GITHUB_OUTPUT
          else
            echo "status=compliant" >> $GITHUB_OUTPUT
            echo "violations=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload license inventory
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: license-inventory
          path: licenses.csv

  govulncheck:
    name: Go Vulnerability Check (govulncheck)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      govulncheck_status: ${{ steps.result.outputs.status }}
      govulncheck_vulns: ${{ steps.result.outputs.vulns }}
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run govulncheck
        id: scan
        continue-on-error: true
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./... 2>&1 | tee govulncheck-output.txt

      - name: Parse govulncheck results
        id: result
        if: always()
        run: |
          if [ "${{ steps.scan.outcome }}" = "success" ]; then
            echo "status=clean" >> $GITHUB_OUTPUT
            echo "vulns=0" >> $GITHUB_OUTPUT
          else
            VULNS=$(grep -c "^Vulnerability #" govulncheck-output.txt 2>/dev/null || echo "unknown")
            echo "status=vulnerabilities-found" >> $GITHUB_OUTPUT
            echo "vulns=${VULNS}" >> $GITHUB_OUTPUT
          fi

  gosec:
    name: Go Security Scanner (gosec)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    outputs:
      gosec_status: ${{ steps.result.outputs.status }}
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run gosec
        id: gosec_scan
        uses: securego/gosec@v2.21.4
        continue-on-error: true
        with:
          args: -no-fail -fmt sarif -out gosec-results.sarif ./...

      - name: Upload gosec SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: gosec-results.sarif
          category: gosec

      - name: Set gosec status
        id: result
        if: always()
        run: |
          if [ -f gosec-results.sarif ]; then
            FINDINGS=$(jq '[.runs[].results[]] | length // 0' gosec-results.sarif 2>/dev/null || echo "0")
          else
            FINDINGS=0
          fi
          if [ "$FINDINGS" -gt 0 ]; then
            echo "status=findings-detected" >> $GITHUB_OUTPUT
          else
            echo "status=clean" >> $GITHUB_OUTPUT
          fi
