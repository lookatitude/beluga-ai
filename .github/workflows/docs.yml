name: Documentation

on:
  push:
    branches: [main]
    paths:
      - "docs/**"
      - "**/*.go"
      - "CHANGELOG.md"
      - "SECURITY.md"
      - "CODE-QUALITY.md"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

env:
  GO_VERSION: "1.25.7"
  NODE_VERSION: "22"

jobs:
  godoc:
    name: Generate GoDoc
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install pkgsite
        run: go install golang.org/x/pkgsite/cmd/pkgsite@latest

      - name: Generate godoc HTML
        run: |
          mkdir -p godoc-output

          # Start pkgsite server in background
          pkgsite -http=:8080 . &
          PKGSITE_PID=$!
          sleep 5

          # Mirror the local documentation
          wget --mirror --convert-links --adjust-extension \
            --page-requisites --no-parent \
            --directory-prefix=godoc-output \
            --no-host-directories \
            --reject="robots.txt" \
            "http://localhost:8080/github.com/lookatitude/beluga-ai" 2>/dev/null || true

          kill $PKGSITE_PID 2>/dev/null || true

      - name: Upload godoc artifact
        uses: actions/upload-artifact@v4
        with:
          name: godoc
          path: godoc-output/

  build-website:
    name: Build Website
    needs: godoc
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"
          cache-dependency-path: docs/website/yarn.lock

      - name: Download godoc artifact
        uses: actions/download-artifact@v4
        with:
          name: godoc
          path: docs/website/public/godoc/

      - name: Copy auto-generated reports into Astro content
        working-directory: docs/website
        run: |
          mkdir -p src/content/docs/reports

          # Copy and inject frontmatter for each report file
          for f in CHANGELOG.md SECURITY.md CODE-QUALITY.md; do
            if [ -f "../../$f" ]; then
              slug=$(basename "$f" .md | tr '[:upper:]' '[:lower:]' | tr '_' '-')

              # Map slugs to human-readable titles
              case "$slug" in
                changelog) title="Changelog" ;;
                security) title="Security" ;;
                code-quality) title="Code Quality" ;;
                *) title="$slug" ;;
              esac

              echo "---" > "src/content/docs/reports/${slug}.md"
              echo "title: ${title}" >> "src/content/docs/reports/${slug}.md"
              echo "---" >> "src/content/docs/reports/${slug}.md"
              echo "" >> "src/content/docs/reports/${slug}.md"
              cat "../../$f" >> "src/content/docs/reports/${slug}.md"

              echo "Copied $f -> reports/${slug}.md"
            else
              echo "Skipping $f (not found)"
            fi
          done

      - name: Install dependencies
        working-directory: docs/website
        run: yarn install --frozen-lockfile

      - name: Build Astro site
        working-directory: docs/website
        run: yarn build

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/website/dist/

  deploy:
    name: Deploy to GitHub Pages
    needs: build-website
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
