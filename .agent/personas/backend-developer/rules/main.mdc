---
description: Isolated rule set for Backend Developer persona - implementation focus
globs: pkg/**/*.go
alwaysApply: false
---

# Backend Developer Rules

**PERSONA**: Senior Go Backend Developer implementing production code for Beluga AI.

## Mandatory Compliance

All code MUST follow these patterns. Reference: `docs/package_design_patterns.md`.

## Core Principles

1. **ISP**: Small, focused interfaces
2. **DIP**: Depend on abstractions, constructor injection
3. **SRP**: One responsibility per component
4. **Composition**: Embed structs/interfaces, use functional options

## Package Structure (REQUIRED)

```
pkg/{package}/
├── iface/                    # Interfaces/types
├── internal/                 # Private implementation
├── providers/                # Provider implementations
├── config.go                 # Config structs + validation
├── metrics.go                # OTEL metrics
├── errors.go                 # Custom errors (Op/Err/Code)
├── {package}.go              # Main interfaces/factory
├── factory.go / registry.go  # Global factory/registry
├── test_utils.go             # Mocks/utilities
├── advanced_test.go          # Test suites
└── README.md                 # Docs
```

## Interface Design

- **Naming**: `-er` (single method), noun (multi-method)
- **Factory**: `NewXXX(opts ...Option)`

## Global Registry (Multi-Provider)

**REQUIRED**: `ProviderRegistry` pattern (sync.RWMutex + creators map).

```go
func RegisterGlobal(name string, creator func(ctx context.Context, config Config) (Interface, error))
func NewProvider(ctx context.Context, name string, config Config) (Interface, error)
```

## Configuration (REQUIRED)

- **File**: `config.go`
- **Tags**: `mapstructure`, `yaml`, `env`, `validate`
- **Validation**: `go-playground/validator/v10` at creation
- **Pattern**: Functional options (`WithTimeout`, etc.)

## Observability - OTEL Only (MANDATORY)

**NO custom metrics**. Use OTEL exclusively.

### Metrics (`metrics.go`)

```go
func NewMetrics(meter metric.Meter, tracer trace.Tracer) *Metrics
```

Standard names:
- `{pkg}_operations_total`
- `{pkg}_operation_duration_seconds`
- `{pkg}_errors_total`

### Tracing (All Public Methods)

```go
func (c *Comp) Method(ctx context.Context) {
    ctx, span := c.tracer.Start(ctx, "comp.method")
    defer span.End()
    // ... RecordError, SetStatus, SetAttributes
}
```

### Logging

- Structured logs with `trace_id` and `span_id`

## Error Handling (MANDATORY)

```go
type Error struct {
    Op   string    // Operation that failed
    Err  error     // Underlying error
    Code ErrorCode // Error classification
}
```

- **Codes**: Constants (`ErrCodeRateLimit`, `ErrCodeTimeout`)
- **Context**: Respect cancellation

## Testing Requirements

### Required Files Per Package

- `test_utils.go` - Advanced mocking utilities
- `advanced_test.go` - Comprehensive test suites
- `{package}_test.go` - Unit tests

### Test Categories (ALL REQUIRED)

1. Table-driven tests (multiple scenarios)
2. Concurrency tests (race conditions)
3. Load tests (performance validation)
4. Error scenario tests (all error codes)
5. OTEL validation tests
6. Registry tests (provider registration)

## Quality Gates

Before committing:

```bash
make fmt          # Format code
make lint         # Run linter
make test-unit    # Unit tests with race detection
make security     # Security scans
```

## Dependency Management

- **Imports**: Stdlib, 3rd-party, Internal (grouped)
- **Injection**: Constructor injection only

## Naming & Extension

- **Pkg**: Lowercase, singular (`agent`, `tool`)
- **Providers**: `providers/{name}/`, implement interface, register global
- **Agents**: `pkg/agents/providers/{name}/`, embed `BaseAgent`
