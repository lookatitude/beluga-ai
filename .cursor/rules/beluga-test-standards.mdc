---
description: Enforce enterprise-grade testing patterns.
globs: **/*_test.go, tests/**
alwaysApply: true
---
# Beluga AI Testing Standards

**MANDATORY**: Comprehensive testing required. Ref: `docs/package_design_patterns.md`.

## Required Files
```
pkg/{package}/
├── test_utils.go           # Advanced mocks/utils (REQUIRED)
├── advanced_test.go        # Comprehensive suites (REQUIRED)
├── {package}_test.go       # Basic unit tests
└── integration_test.go     # Optional package integration
```

## `test_utils.go` (REQUIRED)
-   **Advanced Mock**: `AdvancedMock{Name}` struct with `mock.Mock`, config, health state.
-   **Options**: `WithMockError`, `WithMockDelay`, `NewAdvancedMock...`.
-   **Helpers**: `ConcurrentTestRunner`, `RunLoadTest`, `IntegrationTestHelper`, `ScenarioRunner`.

## `advanced_test.go` Suites (REQUIRED)

### 1. Table-Driven Tests
```go
func TestAdvanced{Pkg}(t *testing.T) {
    tests := []struct {
        name, expectedErr bool
        ops func(...) error
    }{...}
    // Loop and assert
}
```

### 2. Concurrency
Use `ConcurrentTestRunner` with high goroutine count.

### 3. Load Testing
Use `RunLoadTest` with operations/concurrency.

### 4. Error Scenarios
Test Rate Limits, Timeouts, Config errors using error codes.

### 5. Benchmarks
`Benchmark{Pkg}Operations` and `Benchmark{Pkg}Concurrent`.

### 6. OTEL & Registry
Verify metrics/traces recorded. Test provider registration/creation.

## Integration Tests (`tests/integration/`)
-   **Suites**: LLMs↔Memory, Embeddings↔Vectorstores, Agents↔Orchestration, End-to-End RAG.
-   **Location**: `package_pairs/`, `end_to_end/`, `provider_compat/`, `observability/`.

## Coverage & Execution
-   **Target**: 100% (Critical paths MUST be 100%). Min: 80%.
-   **Run**: `make test`, `make test-unit`, `make test-integration`, `make test-race`.

## Quality Gates
-   ✅ Consistent Mocking
-   ✅ Performance/Concurrency/Load Tests
-   ✅ Error/Scenario Coverage
-   ✅ OTEL/Registry Validation
