---
description: Enforce quality assurance standards including linting, formatting, testing, and security.
globs: **/*.go
alwaysApply: true
---
# Beluga AI Quality Standards

**MANDATORY**: All code MUST pass these quality checks. Reference: `Makefile` for command details.

## Build Requirements

- **Go Version**: 1.24+ (matches `go.mod`)
- **Build**: All packages must build successfully
- **Command**: `make build`

## Formatting Requirements

### gofmt/gofumpt (REQUIRED)

- **Tool**: `gofmt` (standard) or `gofumpt` (preferred, stricter)
- **Check**: `make fmt-check` - MUST pass
- **Fix**: `make fmt` - Auto-format code
- **Standard**: All code must be properly formatted

```bash
# Check formatting
make fmt-check

# Auto-fix formatting
make fmt
```

## Linting Requirements

### golangci-lint (REQUIRED)

- **Version**: v2.6.2
- **Check**: `make lint` - MUST pass
- **Fix**: `make lint-fix` - Auto-fix linting issues
- **Note**: Excludes `pkg/agents/providers/react` due to golangci-lint v2.6.2 panic bug
- **Advisory**: Warnings don't block CI, but should be addressed

```bash
# Run linter
make lint

# Auto-fix linting issues
make lint-fix

# Fix specific package
make lint-fix PKG=./pkg/llms
```

**Packages Scanned**: `./pkg/...` and `./tests/...` (excluding react package)

## Static Analysis

### go vet (REQUIRED)

- **Tool**: `go vet` (built-in Go tool)
- **Check**: `make vet` - MUST pass
- **Purpose**: Detects common Go code issues

```bash
# Run go vet
make vet
```

**Packages Scanned**: `./pkg/...`, `./cmd/...`, `./tests/...`

## Test Requirements

### All Tests (REQUIRED)

- **Command**: `make test` - MUST pass
- **Scope**: All unit and integration tests
- **Timeout**: Integration tests have 15-minute timeout

```bash
# Run all tests
make test
```

### Unit Tests (REQUIRED)

- **Command**: `make test-unit` - MUST pass
- **Scope**: Package unit tests only (excluding integration tests)
- **Race Detection**: Enabled by default

```bash
# Run unit tests with race detection
make test-unit
```

### Integration Tests (REQUIRED)

- **Command**: `make test-integration` - MUST pass
- **Scope**: Integration tests in `tests/integration/`
- **Timeout**: 15 minutes
- **Race Detection**: Enabled

```bash
# Run integration tests
make test-integration
```

### Race Detection (REQUIRED)

- **Command**: `make test-race` - MUST pass
- **Purpose**: Detect data races in concurrent code
- **Scope**: All tests with race detector enabled

```bash
# Run tests with race detection
make test-race
```

### Test Coverage (ADVISORY)

- **Command**: `make test-coverage` - Generate coverage report
- **Threshold**: 80% (advisory, not blocking in CI)
- **Target**: Aim for 100% coverage
- **Critical Paths**: Must have 100% coverage (error handling, OTEL, registries)

```bash
# Generate coverage report
make test-coverage

# Check coverage threshold (advisory)
make test-coverage-threshold
```

**Coverage Report**: Generated in `coverage/coverage.html` and `coverage/coverage.out`

## Security Requirements

### gosec (REQUIRED)

- **Tool**: `gosec` (Go security checker)
- **Command**: `make security` - MUST pass
- **Exclusions**: Test directories, mock directories, fixtures
- **Excluded Rules**: G404, G101, G204, G201, G304, G302, G301, G306, G602
- **Report**: `coverage/gosec-report.json`

```bash
# Run security scans (includes gosec, govulncheck, gitleaks)
make security
```

**Note**: Some findings may be false positives - check `gosec-report.json` for details.

### govulncheck (REQUIRED)

- **Tool**: `govulncheck` (Go vulnerability checker)
- **Command**: `make security` - Included in security scan
- **Report**: `coverage/govulncheck-report.txt`

**Purpose**: Check for known vulnerabilities in dependencies.

### gitleaks (REQUIRED)

- **Tool**: `gitleaks` (Secret detection)
- **Command**: `make security` - Included in security scan
- **Config**: `.gitleaks.toml`
- **Report**: `coverage/gitleaks-report.json`
- **Requirement**: NO secrets in code - MUST pass

```bash
# Run gitleaks detection
gitleaks detect --no-banner --redact --config=.gitleaks.toml
```

**Failure**: If secrets are detected, the build fails.

### Trivy (OPTIONAL)

- **Tool**: `trivy` (Container/file system scanner)
- **Command**: `make security-full` - Optional, requires Docker or Trivy binary
- **Scope**: File system scan (excludes specs, examples, docs, website)
- **Severity**: CRITICAL and HIGH only

```bash
# Run full security scan including Trivy
make security-full
```

## CI/CD Requirements

### Local CI Checks

Run all CI checks locally:

```bash
# Run all CI checks (matches CI workflow)
make ci-local
```

**Steps**:
1. Format check (`make fmt-check`)
2. Lint & Format (advisory - warnings don't block)
3. Go vet (`make vet`)
4. Security scans (`make security`)
5. Unit tests (`make test-unit`)
6. Integration tests (`make test-integration`)
7. Coverage check (`make test-coverage-threshold`)
8. Build verification (`make build`)

### CI Workflow

The CI workflow runs:
- `make fmt-check` - Format validation
- `make lint` - Linting (advisory)
- `make vet` - Static analysis
- `make security` - Security scanning
- `make test-unit` - Unit tests
- `make test-integration` - Integration tests
- `make test-coverage-ci` - Coverage report
- `make build` - Build verification

## Quality Checklist

Before committing code, ensure:

- ✅ Code is formatted (`make fmt-check` passes)
- ✅ Linting passes (`make lint` passes)
- ✅ Static analysis passes (`make vet` passes)
- ✅ All tests pass (`make test` passes)
- ✅ Race detection passes (`make test-race` passes)
- ✅ Security scans pass (`make security` passes)
- ✅ No secrets in code (gitleaks passes)
- ✅ Build succeeds (`make build` passes)
- ✅ Coverage meets threshold (80% advisory)

## Tool Installation

### Required Tools

```bash
# Install all required Go tools
make install-tools
```

**Installs**:
- `golangci-lint` v2.6.2
- `gosec` (latest)
- `govulncheck` (latest)
- `gofumpt` (latest)
- `benchstat` (latest)

### System Tools

```bash
# Install system tools (gitleaks, jq)
make install-system-tools
```

**Installs**:
- `gitleaks` (via install script or manual)
- `jq` (via package manager)

## References

- **Makefile**: See `Makefile` for all command definitions
- **Testing Standards**: See `beluga-test-standards.mdc`
- **Design Patterns**: See `beluga-design-patterns.mdc`
- **Architecture**: See `beluga-core-architecture.mdc`
- **Knowledge Base**: See `beluga-knowledge-base.mdc` for KB integration