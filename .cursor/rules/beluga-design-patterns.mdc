---
description: Enforce standardized design patterns, OTEL, and error handling.
globs: **/*.go
alwaysApply: true
---
# Beluga AI Design Patterns

**MANDATORY**: All code MUST follow these patterns. Ref: `docs/package_design_patterns.md`.

## Core Principles
1.  **ISP**: Small interfaces.
2.  **DIP**: Depend on abstractions, constructor injection.
3.  **SRP**: One responsibility.
4.  **Composition**: Embed structs/interfaces, use functional options.

## Package Structure (REQUIRED)
```
pkg/{package}/
├── iface/                    # Interfaces/types
├── internal/                 # Private implementation
├── providers/                # Provider implementations
├── config.go                 # Config structs + validation
├── metrics.go                # OTEL metrics
├── errors.go                 # Custom errors (Op/Err/Code)
├── {package}.go              # Main interfaces/factory
├── factory.go / registry.go  # Global factory/registry
├── test_utils.go             # Mocks/utilities
├── advanced_test.go          # Test suites
└── README.md                 # Docs
```

## Interface Design
-   **Naming**: `-er` (single method), noun (multi-method).
-   **Factory**: `NewXXX(opts ...Option)`.

## Global Registry (Multi-Provider)
**REQUIRED**: `ProviderRegistry` pattern (sync.RWMutex + creators map).
-   `RegisterGlobal(name, creator)`
-   `NewProvider(ctx, name, config)`

## Configuration (REQUIRED)
-   **File**: `config.go`
-   **Tags**: `mapstructure`, `yaml`, `env`, `validate`.
-   **Validation**: `go-playground/validator/v10` at creation.
-   **Pattern**: Functional options (`WithTimeout`, etc.).

## Observability - OTEL Only (MANDATORY)
**NO custom metrics**. Use OTEL.

### Metrics (`metrics.go`)
-   `NewMetrics(meter, tracer)`
-   Standard names: `{pkg}_operations_total`, `{pkg}_operation_duration_seconds`, `{pkg}_errors_total`.

### Tracing (Public Methods)
```go
func (c *Comp) Method(ctx context.Context) {
    ctx, span := c.tracer.Start(ctx, "comp.method")
    defer span.End()
    // ... RecordError, SetStatus, SetAttributes
}
```

### Logging
-   Structured logs with `trace_id` and `span_id`.

## Error Handling (MANDATORY)
-   **Struct**: `Op`, `Err`, `Code`.
-   **Codes**: Constants (`ErrCodeRateLimit`, `ErrCodeTimeout`).
-   **Context**: Respect cancellation.

## Dependency Management
-   **Imports**: Stdlib, 3rd-party, Internal (grouped).
-   **Injection**: Constructor injection.

## Naming & Extension
-   **Pkg**: Lowercase, singular (`agent`, `tool`).
-   **Providers**: `providers/{name}.go`, implement interface, register global.
-   **Agents**: `pkg/agents/providers/{name}/`, embed `BaseAgent`.

## References
-   `beluga-core-architecture.mdc`, `beluga-test-standards.mdc`
-   `beluga-quality-standards.mdc`, `beluga-knowledge-base.mdc`
