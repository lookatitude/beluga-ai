---
description: Enforce Beluga AI Framework's architecture and modularity.
globs: pkg/**
alwaysApply: true
---
# Beluga AI Architecture

**MANDATORY**: All code in `pkg/` MUST follow this architecture. Ref: `docs/architecture.md`.

## System Overview

**Layered Architecture**: `App` → `Agent` → `Orchestration` → `LLM` → `RAG` → `Memory` → `Infrastructure`

## Package Structure

### Foundation (No Dependencies)
- **`pkg/schema`**: Centralized data structures and message types (Single Source of Truth).
- **`pkg/core`**: Fundamental utilities and core models.
- **`pkg/config`**: Framework-wide config loading/validation (Viper/Env).
- **`pkg/monitoring`**: OTEL observability (Metrics, Tracing, Logs).

### Provider Packages (Depend on Foundation)
- **`pkg/llms`**: LLM interactions (Multi-provider, Streaming).
- **`pkg/embeddings`**: Text embeddings (Interface-driven).
- **`pkg/vectorstores`**: Vector DB interfaces (Abstraction).
- **`pkg/prompts`**: Prompt templating and management.

### Higher-Level Packages (Depend on Providers)
- **`pkg/chatmodels`**: Chat-based interactions, tool binding.
- **`pkg/memory`**: Conversation memory (Buffer, Summary, Vector).
- **`pkg/retrievers`**: Information retrieval (RAG).
- **`pkg/agents`**: AI agent framework (Interface-driven).
- **`pkg/orchestration`**: Workflows, scheduler, message bus.
- **`pkg/server`**: APIs (REST, MCP, Streaming).

## Design Principles

1.  **Modular**: Separation of concerns (SRP).
2.  **Interface-Driven**: ISP, DIP, easy substitution.
3.  **Composition**: Embed Base types, functional options.
4.  **Observability**: **MANDATORY** OTEL ONLY (Metrics, Tracing, Logs).
5.  **Config**: `pkg/config` integration, env vars, validation.

## Extension Patterns

-   **LLM Provider**: Implement `LLMCaller` in `pkg/llms/providers/`, register global.
-   **Agent Type**: Embed `BaseAgent`, implement `Agent` in `pkg/agents/providers/`.
-   **Vector Store**: Implement `VectorStore` in `pkg/vectorstores/providers/`.
-   **Tool**: Implement `Tool` in `pkg/agents/tools/`.

## Integration Points

-   **RAG**: Query → Retriever → Embedder → VectorStore → LLM
-   **Agent**: Input → Agent → Planner → Executor → Tools → LLM → Memory
-   **Multi-Agent**: Coordinator → Scheduler → Agents → MessageBus
-   **Cross-Package**: Use `pkg/schema` (data), `pkg/config`, `pkg/monitoring`, `tests/integration/`.

## References
-   `docs/architecture.md`, `beluga-design-patterns.mdc`
-   `beluga-test-standards.mdc`, `beluga-quality-standards.mdc`
