# Data Model: Multimodal Models Support

**Feature**: Multimodal Models Support  
**Date**: 2025-01-27  
**Status**: Complete

## Overview

This document defines the data model for the multimodal models support feature. It includes entity definitions, relationships, validation rules, and state transitions.

## Core Entities

### MultimodalModel

Represents a multimodal model provider that can process multiple data types (text, images, audio, video).

**Fields**:
- `ID` (string): Unique identifier for the model instance
- `Provider` (string): Provider name (e.g., "openai", "google", "anthropic")
- `Name` (string): Model name (e.g., "gpt-4o", "gemini-pro")
- `Capabilities` (ModalityCapabilities): Supported modalities and their capabilities
- `Config` (Config): Configuration for the model
- `CreatedAt` (time.Time): Creation timestamp
- `UpdatedAt` (time.Time): Last update timestamp

**Relationships**:
- Has one `Config`
- Has one `ModalityCapabilities`
- Belongs to a `MultimodalProvider`

**Validation Rules**:
- `Provider` must be non-empty and registered
- `Name` must be non-empty
- `Config` must be valid (validated via Config.Validate())
- `Capabilities` must have at least one supported modality

**State Transitions**:
- `Initializing` → `Ready` (after successful initialization)
- `Ready` → `Processing` (when processing input)
- `Processing` → `Ready` (after processing completes)
- `Ready` → `Error` (on error)
- `Error` → `Ready` (after recovery)

### MultimodalInput

Represents a multimodal input containing one or more content types (text, images, audio, video).

**Fields**:
- `ID` (string): Unique identifier for the input
- `ContentBlocks` ([]ContentBlock): List of content blocks
- `Metadata` (map[string]any): Additional metadata
- `Format` (string): Preferred format (base64, url, file_path)
- `Routing` (RoutingConfig): Routing instructions for content blocks
- `CreatedAt` (time.Time): Creation timestamp

**Relationships**:
- Has many `ContentBlock`
- Has one `RoutingConfig`
- Produces one `MultimodalOutput`

**Validation Rules**:
- Must have at least one `ContentBlock`
- Each `ContentBlock` must be valid
- `Format` must be one of: "base64", "url", "file_path"
- `Routing` must be valid`

### ContentBlock

Represents a single content block (text, image, audio, video) within multimodal input/output.

**Fields**:
- `Type` (string): Content type ("text", "image", "audio", "video")
- `Data` ([]byte): Content data (base64 encoded or raw)
- `URL` (string): URL to content (if applicable)
- `FilePath` (string): File path to content (if applicable)
- `MIMEType` (string): MIME type (e.g., "image/png", "audio/mpeg")
- `Format` (string): Format (e.g., "png", "mp3", "mp4")
- `Size` (int64): Size in bytes
- `Metadata` (map[string]any): Additional metadata

**Relationships**:
- Belongs to `MultimodalInput` or `MultimodalOutput`

**Validation Rules**:
- `Type` must be one of: "text", "image", "audio", "video"
- Must have at least one of: `Data`, `URL`, `FilePath`
- `MIMEType` must be valid for the content type
- `Size` must be >= 0
- If `Data` is provided, it must be valid base64 or raw bytes
- If `URL` is provided, it must be a valid URL
- If `FilePath` is provided, file must exist and be readable

**State Transitions**:
- `Pending` → `Normalizing` (when normalization starts)
- `Normalizing` → `Ready` (after normalization completes)
- `Ready` → `Processing` (when processing starts)
- `Processing` → `Processed` (after processing completes)
- Any state → `Error` (on error)

### MultimodalOutput

Represents a multimodal output generated by a model.

**Fields**:
- `ID` (string): Unique identifier for the output
- `InputID` (string): Reference to input that produced this output
- `ContentBlocks` ([]ContentBlock): Generated content blocks
- `Metadata` (map[string]any): Additional metadata
- `Confidence` (float32): Confidence score (0.0-1.0)
- `Provider` (string): Provider that generated the output
- `Model` (string): Model that generated the output
- `CreatedAt` (time.Time): Creation timestamp

**Relationships**:
- Belongs to `MultimodalInput`
- Has many `ContentBlock`

**Validation Rules**:
- Must have at least one `ContentBlock`
- Each `ContentBlock` must be valid
- `Confidence` must be between 0.0 and 1.0
- `Provider` must be non-empty
- `Model` must be non-empty

### MultimodalProvider

Represents a provider implementation for multimodal models.

**Fields**:
- `Name` (string): Provider name (e.g., "openai", "google")
- `Factory` (ProviderFactory): Factory function for creating model instances
- `Capabilities` (ModalityCapabilities): Provider capabilities
- `ConfigSchema` (ConfigSchema): Configuration schema
- `RegisteredAt` (time.Time): Registration timestamp

**Relationships**:
- Has many `MultimodalModel`
- Has one `ModalityCapabilities`
- Has one `ConfigSchema`

**Validation Rules**:
- `Name` must be non-empty and unique
- `Factory` must be non-nil
- `Capabilities` must be valid
- `ConfigSchema` must be valid

### ModalityCapabilities

Represents the capabilities of a provider or model for different modalities.

**Fields**:
- `Text` (bool): Supports text processing
- `Image` (bool): Supports image processing
- `Audio` (bool): Supports audio processing
- `Video` (bool): Supports video processing
- `MaxImageSize` (int64): Maximum image size in bytes
- `MaxAudioSize` (int64): Maximum audio size in bytes
- `MaxVideoSize` (int64): Maximum video size in bytes
- `SupportedImageFormats` ([]string): Supported image formats
- `SupportedAudioFormats` ([]string): Supported audio formats
- `SupportedVideoFormats` ([]string): Supported video formats

**Relationships**:
- Belongs to `MultimodalModel` or `MultimodalProvider`

**Validation Rules**:
- Must support at least one modality
- Size limits must be >= 0
- Format lists must be non-empty if modality is supported

### Config

Represents configuration for multimodal operations.

**Fields**:
- `Provider` (string): Provider name
- `Model` (string): Model name
- `APIKey` (string): API key
- `BaseURL` (string): Base URL for API
- `Timeout` (time.Duration): Request timeout
- `MaxRetries` (int): Maximum retry attempts
- `RetryDelay` (time.Duration): Delay between retries
- `EnableStreaming` (bool): Enable streaming support
- `StreamChunkSize` (int64): Chunk size for streaming
- `ProviderSpecific` (map[string]any): Provider-specific settings

**Relationships**:
- Belongs to `MultimodalModel`

**Validation Rules**:
- `Provider` must be non-empty and registered
- `Model` must be non-empty
- `APIKey` must be non-empty (unless provider doesn't require it)
- `Timeout` must be > 0
- `MaxRetries` must be >= 0
- `RetryDelay` must be >= 0
- `StreamChunkSize` must be > 0 if streaming enabled

### RoutingConfig

Represents routing instructions for content blocks.

**Fields**:
- `Strategy` (string): Routing strategy ("auto", "manual", "fallback")
- `TextProvider` (string): Provider for text content
- `ImageProvider` (string): Provider for image content
- `AudioProvider` (string): Provider for audio content
- `VideoProvider` (string): Provider for video content
- `FallbackToText` (bool): Fallback to text-only if modality not supported

**Relationships**:
- Belongs to `MultimodalInput`

**Validation Rules**:
- `Strategy` must be one of: "auto", "manual", "fallback"
- If `Strategy` is "manual", at least one provider must be specified
- Providers must be registered if specified

## Entity Relationships

```
MultimodalProvider
  ├── has many MultimodalModel
  ├── has one ModalityCapabilities
  └── has one ConfigSchema

MultimodalModel
  ├── belongs to MultimodalProvider
  ├── has one Config
  ├── has one ModalityCapabilities
  └── processes MultimodalInput → produces MultimodalOutput

MultimodalInput
  ├── has many ContentBlock
  ├── has one RoutingConfig
  └── produces MultimodalOutput

MultimodalOutput
  ├── belongs to MultimodalInput
  └── has many ContentBlock

ContentBlock
  ├── belongs to MultimodalInput or MultimodalOutput
  └── has metadata (map[string]any)
```

## Validation Rules Summary

### MultimodalModel
- Provider must be registered
- Name must be non-empty
- Config must be valid
- Must support at least one modality

### MultimodalInput
- Must have at least one ContentBlock
- Format must be valid
- Routing must be valid

### ContentBlock
- Type must be valid
- Must have at least one data source (Data, URL, or FilePath)
- MIME type must be valid
- Size must be >= 0

### MultimodalOutput
- Must have at least one ContentBlock
- Confidence must be 0.0-1.0
- Provider and Model must be non-empty

### Config
- Provider must be registered
- Model must be non-empty
- APIKey required (unless provider doesn't require it)
- Timeouts and retries must be valid

## State Transitions

### MultimodalModel States
```
Initializing → Ready → Processing → Ready
                ↓
              Error → Ready (after recovery)
```

### ContentBlock States
```
Pending → Normalizing → Ready → Processing → Processed
                            ↓
                          Error
```

## Data Flow

1. **Input Creation**: User creates `MultimodalInput` with `ContentBlock`s
2. **Normalization**: Content blocks are normalized to provider-preferred formats
3. **Routing**: Content blocks are routed to appropriate providers based on `RoutingConfig`
4. **Processing**: Providers process content blocks and generate results
5. **Output Creation**: `MultimodalOutput` is created with generated `ContentBlock`s
6. **Validation**: Output is validated against requirements

## Notes

- All entities support context cancellation
- All entities include timestamps for observability
- Metadata fields allow extensibility without schema changes
- Size limits are enforced to prevent memory issues
- Format validation ensures provider compatibility
