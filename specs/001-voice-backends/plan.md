# Implementation Plan: Voice Backends

**Branch**: `001-voice-backends` | **Date**: 2025-01-27 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-voice-backends/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

**Primary Requirement**: Implement a comprehensive voice backend framework that manages real-time voice pipelines for AI agents, supporting multiple backend providers (LiveKit, Pipecat, Vocode, Vapi, Cartesia, etc.) with full integration into the Beluga AI Framework ecosystem.

**Technical Approach**: 
- Full implementation (no MVPs) with complete feature set including STT/TTS/S2S pipelines, turn detection, agent integration, multi-user scalability, and extensibility hooks
- Deep integration with existing Beluga packages: `agents`, `config`, `vectorstores`, `memory`, `multimodal`, `orchestration`, `monitoring`, `schema`, `voice`, `prompts`, `retrievers`, `server`, `core`, `chatmodels`, `embeddings`
- Provider registry pattern following `pkg/llms`, `pkg/embeddings`, and `pkg/multimodal` patterns
- LiveKit Go SDK integration (`github.com/livekit/server-sdk-go`) as primary provider
- HTTP/gRPC integration for alternative providers (Pipecat, Vocode, Vapi, Cartesia)
- Replicate LiveKit Agents patterns in Go using Beluga AI components

## Technical Context

**Language/Version**: Go 1.24.1+  
**Primary Dependencies**: 
- `github.com/livekit/server-sdk-go` (latest version) - LiveKit Go SDK
- `github.com/livekit/protocol` - LiveKit protocol buffers
- `github.com/gorilla/websocket` v1.5.3 - WebSocket support for alternative providers
- `go.opentelemetry.io/otel` v1.39.0 - OTEL observability
- `github.com/go-playground/validator/v10` v10.30.1 - Configuration validation
- All existing Beluga AI packages (agents, config, voice, memory, orchestration, etc.)

**Storage**: 
- In-memory session state for active sessions (with optional persistence hooks)
- Provider-controlled storage for completed sessions
- Integration with `pkg/memory` for conversation context
- Integration with `pkg/vectorstores` for RAG-enabled voice agents

**Testing**: 
- `go test` with table-driven tests in `advanced_test.go`
- Mocks in `test_utils.go` following `AdvancedMock` patterns
- Benchmarks for latency and concurrency
- Integration tests in `tests/integration/voice/backend/`

**Target Platform**: Linux server (cloud-hosted or self-hosted)  
**Project Type**: Single Go package (`pkg/voice/backend/`) with multi-provider architecture  
**Performance Goals**: 
- End-to-end latency <500ms for 95% of interactions (STT+TTS pipeline)
- S2S pipeline latency <300ms for 95% of interactions
- Support 100+ concurrent voice conversations per backend instance
- Zero application code changes when switching providers

**Constraints**: 
- Must maintain <500ms end-to-end latency for real-time voice interactions
- Must support graceful degradation on network issues
- Must handle connection failures and recover automatically
- Must respect context cancellation throughout pipeline
- Must integrate with existing Beluga AI packages without breaking changes

**Scale/Scope**: 
- Production-ready implementation supporting enterprise-scale deployments
- Multi-user concurrent conversations (100+ per instance)
- Multiple backend providers (LiveKit, Pipecat, Vocode, Vapi, Cartesia, TEN Framework, Retell/Ultravox/Bland)
- Full feature set: STT/TTS/S2S pipelines, turn detection, agent integration, extensibility hooks

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Package Structure Compliance ✅

- [x] `pkg/voice/backend/iface/` - Interfaces and types (REQUIRED)
- [x] `pkg/voice/backend/internal/` - Private implementation details
- [x] `pkg/voice/backend/providers/` - Provider implementations (multi-provider package)
- [x] `pkg/voice/backend/config.go` - Configuration structs and validation (REQUIRED)
- [x] `pkg/voice/backend/metrics.go` - OTEL metrics implementation (REQUIRED)
- [x] `pkg/voice/backend/errors.go` - Custom error types with Op/Err/Code pattern (REQUIRED)
- [x] `pkg/voice/backend/backend.go` - Main interfaces and factory functions
- [x] `pkg/voice/backend/registry.go` - Global registry for multi-provider package
- [x] `pkg/voice/backend/test_utils.go` - Advanced testing utilities and mocks (REQUIRED)
- [x] `pkg/voice/backend/advanced_test.go` - Comprehensive test suites (REQUIRED)
- [x] `pkg/voice/backend/README.md` - Package documentation (REQUIRED)

### Interface Design Compliance ✅

- [x] Interface Segregation Principle (ISP): Small, focused interfaces
- [x] Dependency Inversion Principle (DIP): Depend on abstractions, constructor injection
- [x] "er" suffix pattern where appropriate (e.g., `VoiceBackend`, `BackendProvider`)
- [x] Multiple small interfaces over one large interface

### Provider Registry Pattern Compliance ✅

- [x] `GetRegistry()` function for global registry access
- [x] `Register()` method for provider registration
- [x] `Create()` method for provider instantiation
- [x] Provider registration in `providers/*/init.go` files
- [x] Match existing patterns from `pkg/llms/`, `pkg/embeddings/`, `pkg/multimodal/`

### OTEL Observability Compliance ✅

- [x] OTEL metrics in `metrics.go` (counters, histograms for latency, throughput, concurrency)
- [x] OTEL tracing for all public methods with span attributes
- [x] Structured logging with OTEL context (trace IDs, span IDs)
- [x] Use `logWithOTELContext` helper function following framework patterns
- [x] Record errors with `span.RecordError()` and set status codes

### Error Handling Compliance ✅

- [x] Error struct with Op, Err, Code, Message fields
- [x] Error codes for common failures (provider_not_found, invalid_config, connection_failed, etc.)
- [x] Context cancellation support throughout pipeline
- [x] Error helper functions: `NewError`, `WrapError`, `IsError`, `AsError`

### Configuration Compliance ✅

- [x] Config struct with mapstructure, yaml, env, validate tags
- [x] Functional options for runtime configuration
- [x] Validation at creation time using validator library
- [x] Default values where appropriate
- [x] Integration with `pkg/config` for validation utilities

### Testing Compliance ✅

- [x] Table-driven tests in `advanced_test.go`
- [x] Mocks in `test_utils.go` following `AdvancedMock` patterns
- [x] Benchmarks for performance-critical operations (latency, concurrency)
- [x] Integration tests for cross-package compatibility
- [x] Test coverage >80% target

### Backward Compatibility Compliance ✅

- [x] No breaking changes to existing APIs
- [x] New functionality is opt-in where possible
- [x] Integration with existing packages maintains compatibility

### Integration with Existing Packages ✅

- [x] **agents**: Full integration for transcript routing and response generation
- [x] **config**: Configuration validation and management
- [x] **vectorstores**: Optional integration for RAG-enabled voice agents
- [x] **memory**: Session state management and conversation context
- [x] **multimodal**: Audio content handling in multimodal workflows
- [x] **orchestration**: Workflow orchestration for complex voice pipelines
- [x] **monitoring**: OTEL setup and observability patterns
- [x] **schema**: Voice document and message types
- [x] **voice**: STT, TTS, S2S, VAD, turn detection, noise cancellation
- [x] **prompts**: Agent prompt management
- [x] **retrievers**: RAG integration for voice agents
- [x] **server**: HTTP endpoints if needed
- [x] **core**: Utilities and base interfaces
- [x] **chatmodels**: Agent LLM integration
- [x] **embeddings**: RAG embedding support

**Constitution Status**: ✅ **PASS** - All gates pass. Full compliance with Beluga AI Framework constitution.

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
pkg/voice/backend/
├── iface/                          # Interface definitions (ISP compliant)
│   ├── voice_backend.go           # Core VoiceBackend interface
│   ├── backend_provider.go        # BackendProvider interface
│   ├── voice_session.go            # VoiceSession interface
│   ├── pipeline.go                 # PipelineConfiguration interface
│   └── hooks.go                    # Extensibility hooks (AuthHook, RateLimiter, DataRetentionHook)
├── internal/                        # Private implementation details
│   ├── pipeline_orchestrator.go   # Pipeline orchestration (STT/TTS/S2S)
│   ├── session_manager.go         # Session lifecycle management
│   ├── turn_detector.go           # Turn detection integration
│   ├── agent_bridge.go            # Agent integration bridge
│   ├── audio_buffer.go            # Audio buffer management
│   └── mock/                       # Mock implementations for testing
│       ├── mock_backend.go
│       ├── mock_provider.go
│       └── mock_session.go
├── providers/                      # Provider implementations
│   ├── livekit/                   # LiveKit provider
│   │   ├── config.go              # LiveKit-specific configuration
│   │   ├── provider.go            # LiveKit provider implementation
│   │   ├── session.go             # LiveKit session management
│   │   ├── room_manager.go       # LiveKit room/participant management
│   │   ├── audio_handler.go      # LiveKit audio track handling
│   │   ├── init.go                # Auto-registration
│   │   └── provider_test.go       # Provider tests
│   ├── pipecat/                   # Pipecat provider (via Daily.co API)
│   │   ├── config.go
│   │   ├── provider.go
│   │   ├── session.go
│   │   ├── init.go
│   │   └── provider_test.go
│   ├── vocode/                    # Vocode provider (HTTP API)
│   │   ├── config.go
│   │   ├── provider.go
│   │   ├── session.go
│   │   ├── init.go
│   │   └── provider_test.go
│   ├── vapi/                      # Vapi provider (HTTP API)
│   │   ├── config.go
│   │   ├── provider.go
│   │   ├── session.go
│   │   ├── init.go
│   │   └── provider_test.go
│   ├── cartesia/                  # Cartesia provider (HTTP API)
│   │   ├── config.go
│   │   ├── provider.go
│   │   ├── session.go
│   │   ├── init.go
│   │   └── provider_test.go
│   └── mock/                      # Mock provider for testing
│       ├── config.go
│       ├── provider.go
│       ├── session.go
│       ├── init.go
│       └── provider_test.go
├── config.go                       # Configuration structs and validation
├── metrics.go                      # OTEL metrics implementation
├── errors.go                       # Custom error types
├── backend.go                # Main interfaces and factory functions
├── registry.go                     # Global provider registry
├── test_utils.go                   # Advanced testing utilities and mocks
├── advanced_test.go               # Comprehensive test suites
└── README.md                       # Package documentation

tests/integration/voice/backend/
├── livekit_integration_test.go    # LiveKit integration tests
├── pipecat_integration_test.go    # Pipecat integration tests
├── multi_provider_test.go         # Cross-provider compatibility tests
├── agent_integration_test.go      # Agent integration tests
├── memory_integration_test.go     # Memory integration tests
├── orchestration_integration_test.go  # Orchestration integration tests
├── rag_integration_test.go        # RAG (retrievers/vectorstores) integration tests
└── performance_test.go            # Performance and concurrency tests
```

**Structure Decision**: Single Go package (`pkg/voice/backend/`) following the standard Beluga AI Framework multi-provider package structure. The package integrates deeply with existing Beluga packages:
- Uses `pkg/voice` for STT/TTS/S2S/VAD/turn detection
- Uses `pkg/agents` for agent integration
- Uses `pkg/memory` for session context
- Uses `pkg/orchestration` for workflow orchestration
- Uses `pkg/retrievers` and `pkg/vectorstores` for RAG-enabled voice agents
- Uses `pkg/multimodal` for audio content handling
- Uses `pkg/monitoring` for OTEL observability
- Uses `pkg/config` for configuration validation
- Uses `pkg/schema` for voice documents and messages
- Uses `pkg/core` for utilities and base interfaces

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

**No violations**: All design decisions comply with the Beluga AI Framework constitution. The implementation follows established patterns from `pkg/llms`, `pkg/embeddings`, `pkg/multimodal`, and other multi-provider packages.

## Integration Architecture

### Full Package Integration Map

The voice backends package integrates with **ALL** relevant Beluga AI packages:

```
┌─────────────────────────────────────────────────────────────┐
│              pkg/voice/backend/                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Provider Registry (LiveKit, Pipecat, Vocode, etc.)  │  │
│  └──────────────────────────────────────────────────────┘  │
│                            │                                 │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Pipeline Orchestrator                                │  │
│  │  - STT → Agent → TTS Pipeline                        │  │
│  │  - S2S Pipeline                                       │  │
│  │  - Turn Detection                                     │  │
│  └──────────────────────────────────────────────────────┘  │
│                            │                                 │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Session Manager                                      │  │
│  │  - Session Lifecycle                                  │  │
│  │  - Multi-user Concurrency                             │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│ pkg/voice/   │   │ pkg/agents/  │   │ pkg/memory/  │
│ - STT        │   │ - Agent      │   │ - Context    │
│ - TTS        │   │ - Tools      │   │ - History    │
│ - S2S        │   │ - Executor   │   │ - State      │
│ - VAD        │   │              │   │              │
│ - Turn Det.  │   │              │   │              │
└──────────────┘   └──────────────┘   └──────────────┘
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│pkg/multimodal│   │pkg/orchestr. │   │pkg/retrievers │
│ - Audio     │   │ - Chains     │   │ - RAG        │
│ - Content   │   │ - Workflows  │   │ - Search     │
└──────────────┘   └──────────────┘   └──────────────┘
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│pkg/vectorstores│ │pkg/monitoring │   │pkg/config/   │
│ - Storage    │   │ - OTEL        │   │ - Validation │
│ - Embeddings │   │ - Metrics     │   │ - Options    │
└──────────────┘   └──────────────┘   └──────────────┘
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│pkg/schema/   │   │pkg/prompts/  │   │pkg/core/     │
│ - Documents  │   │ - Templates  │   │ - Utils      │
│ - Messages   │   │ - Management │   │ - Interfaces │
└──────────────┘   └──────────────┘   └──────────────┘
```

### Integration Points

1. **Voice Package Integration** (`pkg/voice/`):
   - Use `pkg/voice/stt` for speech-to-text
   - Use `pkg/voice/tts` for text-to-speech
   - Use `pkg/voice/s2s` for speech-to-speech
   - Use `pkg/voice/vad` for voice activity detection
   - Use `pkg/voice/turndetection` for turn detection
   - Use `pkg/voice/noise` for noise cancellation
   - Use `pkg/voice/transport` for audio transport patterns

2. **Agent Integration** (`pkg/agents/`):
   - Route transcripts to agents via `pkg/agents` interfaces
   - Receive agent responses for TTS conversion
   - Support agent tools and tool calling
   - Integrate with agent lifecycle management

3. **Memory Integration** (`pkg/memory/`):
   - Use `pkg/memory` for conversation context storage
   - Load memory variables for agent context
   - Save conversation history per session
   - Support multiple memory types (buffer, window, vector store)

4. **Orchestration Integration** (`pkg/orchestration/`):
   - Use `pkg/orchestration` for complex workflow orchestration
   - Trigger workflows based on voice events
   - Support chain and graph orchestration patterns
   - Integrate with workflow scheduling

5. **RAG Integration** (`pkg/retrievers/`, `pkg/vectorstores/`, `pkg/embeddings/`):
   - Use `pkg/retrievers` for document retrieval in voice agents
   - Use `pkg/vectorstores` for semantic search
   - Use `pkg/embeddings` for embedding generation
   - Enable RAG-enabled voice agents with knowledge base access

6. **Multimodal Integration** (`pkg/multimodal/`):
   - Handle audio content within multimodal messages
   - Support audio in multimodal agent workflows
   - Integrate with multimodal model providers

7. **Monitoring Integration** (`pkg/monitoring/`):
   - Use `pkg/monitoring` for OTEL setup
   - Emit metrics for latency, concurrency, errors, throughput
   - Create distributed traces for end-to-end flows
   - Structured logging with OTEL context

8. **Configuration Integration** (`pkg/config/`):
   - Use `pkg/config` validation utilities
   - Follow configuration patterns from existing packages
   - Support environment variable configuration
   - Functional options for runtime configuration

9. **Schema Integration** (`pkg/schema/`):
   - Use `pkg/schema` for voice documents and messages
   - Support voice document types
   - Integrate with message schemas

10. **Core Integration** (`pkg/core/`):
    - Use `pkg/core` utilities
    - Implement `core.Runnable` where appropriate
    - Use core interfaces and base types

11. **Prompts Integration** (`pkg/prompts/`):
    - Use `pkg/prompts` for agent prompt management
    - Support prompt templates in voice agents

12. **ChatModels Integration** (`pkg/chatmodels/`):
    - Use `pkg/chatmodels` for agent LLM integration
    - Support chat model providers in voice agents

## Phase Completion Status

### Phase 0: Research ✅ COMPLETE

- [x] Research LiveKit Go SDK and latest versions
- [x] Research Pipecat integration patterns
- [x] Research alternative providers (Vocode, Vapi, Cartesia)
- [x] Research LiveKit Agents patterns for replication
- [x] Research integration patterns with existing Beluga packages
- [x] Document all findings in `research.md`

**Output**: `research.md` with all technical decisions and integration patterns

### Phase 1: Design & Contracts ✅ COMPLETE

- [x] Generate `data-model.md` with core entities
- [x] Generate API contracts in `contracts/` directory
- [x] Generate `quickstart.md` with usage examples
- [x] Update agent context with new technology

**Output**: `data-model.md`, `contracts/voice-backend-api.md`, `contracts/provider-registry-api.md`, `quickstart.md`

### Phase 2: Implementation Planning ✅ COMPLETE

- [x] Generate detailed `tasks.md` with dependency-ordered tasks
- [x] Ensure full implementation (no MVPs)
- [x] Ensure integration with all relevant Beluga packages
- [x] Verify compliance with design patterns

**Output**: `tasks.md` with comprehensive implementation tasks (331 tasks total)

## Implementation Principles

### Full Implementation (No MVPs)

This feature implements **ALL** requirements from the specification:
- ✅ All user stories (P1, P2, P3 priorities)
- ✅ All functional requirements (FR-001 through FR-028)
- ✅ All success criteria (SC-001 through SC-010)
- ✅ All edge cases and error handling
- ✅ All observability requirements
- ✅ All extensibility hooks
- ✅ All provider implementations (LiveKit, Pipecat, Vocode, Vapi, Cartesia)

### Deep Package Integration

This feature integrates with **ALL** relevant Beluga AI packages:
- ✅ `pkg/agents` - Agent integration
- ✅ `pkg/config` - Configuration management
- ✅ `pkg/vectorstores` - RAG storage
- ✅ `pkg/memory` - Session context
- ✅ `pkg/multimodal` - Audio content handling
- ✅ `pkg/orchestration` - Workflow orchestration
- ✅ `pkg/monitoring` - OTEL observability
- ✅ `pkg/schema` - Voice documents
- ✅ `pkg/voice` - STT/TTS/S2S/VAD/turn detection
- ✅ `pkg/prompts` - Agent prompts
- ✅ `pkg/retrievers` - RAG retrieval
- ✅ `pkg/server` - HTTP endpoints (if needed)
- ✅ `pkg/core` - Utilities
- ✅ `pkg/chatmodels` - Agent LLMs
- ✅ `pkg/embeddings` - RAG embeddings

### Design Pattern Compliance

This feature follows **ALL** Beluga AI Framework design patterns:
- ✅ Provider registry pattern (like `pkg/llms`, `pkg/embeddings`, `pkg/multimodal`)
- ✅ Configuration validation (like `pkg/config`)
- ✅ OTEL observability (like `pkg/monitoring`, `pkg/llms`)
- ✅ Error handling (like all packages)
- ✅ Testing patterns (like `pkg/llms`, `pkg/embeddings`)
- ✅ Interface segregation (ISP)
- ✅ Dependency inversion (DIP)
- ✅ Single responsibility (SRP)
- ✅ Composition over inheritance

## Progress Tracking
*This checklist is updated during execution flow*

**Phase Status**:
- [x] Phase 0: Research complete (/plan command) ✅ COMPLETE - research.md generated
- [x] Phase 1: Design complete (/plan command) ✅ COMPLETE - data-model.md, contracts/, quickstart.md generated
- [x] Phase 2: Task planning complete (/plan command - describe approach only) ✅ COMPLETE - approach documented
- [x] Phase 3: Tasks generated (/tasks command) ✅ COMPLETE - tasks.md created (331 tasks)
- [x] Phase 4: Implementation complete ✅ COMPLETE - All tasks implemented
- [x] Phase 5: Validation passed ✅ COMPLETE - Tests passing, validation complete

**Gate Status**:
- [x] Initial Constitution Check: PASS ✅ - Package Structure Compliance, Design Principles Compliance, Observability & Quality Standards
- [x] Post-Design Constitution Check: PASS ✅ - All design checks passed
- [x] All NEEDS CLARIFICATION resolved ✅ - All clarifications addressed
- [x] Complexity deviations documented ✅ - No violations

---
*Based on Constitution v2.1.1 - See `/memory/constitution.md`*
