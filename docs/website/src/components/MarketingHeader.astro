---
import config from "@/config/config.json";
import menu from "@/config/menu.en.json";
import social from "@/config/social.json";
import MegaMenu from "./MegaMenu.astro";
import ImageMod from "./ImageMod.astro";

const { site, navigation_button } = config;
const navItems = menu.main;
const githubLink = social.main.find((s: any) => s.icon === "github");
const currentPath = Astro.url.pathname;
---

<header class="marketing-header" data-header>
  <div class="marketing-header-inner">
    <!-- Logo -->
    <a href="/" class="marketing-logo" aria-label={site.logo_text}>
      <ImageMod
        src={site.logo_darkmode}
        alt={site.logo_text}
        width={Number(site.logo_width)}
        height={Number(site.logo_height)}
        class="logo-dark"
        format="svg"
      />
      <ImageMod
        src={site.logo}
        alt={site.logo_text}
        width={Number(site.logo_width)}
        height={Number(site.logo_height)}
        class="logo-light"
        format="svg"
      />
    </a>

    <!-- Desktop nav -->
    <nav class="marketing-nav" aria-label="Main navigation">
      <ul class="marketing-nav-list">
        {
          navItems.map((item: any) => (
            <li class={`marketing-nav-item ${item.megaMenu ? "has-mega-menu" : ""}`}>
              {item.megaMenu ? (
                <button
                  class={`marketing-nav-link ${currentPath.startsWith(item.url) ? "active" : ""}`}
                  data-mega-trigger
                  aria-expanded="false"
                  aria-haspopup="true"
                >
                  {item.name}
                  <svg
                    class="chevron-icon"
                    width="10"
                    height="10"
                    viewBox="0 0 10 10"
                    fill="none"
                  >
                    <path
                      d="M2 4l3 3 3-3"
                      stroke="currentColor"
                      stroke-width="1.5"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                  <MegaMenu />
                </button>
              ) : (
                <a
                  href={item.url}
                  class={`marketing-nav-link ${currentPath === item.url || currentPath.startsWith(item.url) ? "active" : ""}`}
                >
                  {item.name}
                </a>
              )}
            </li>
          ))
        }
      </ul>
    </nav>

    <!-- Right actions -->
    <div class="marketing-header-actions">
      <!-- Search slot (used by docs pages) -->
      <slot name="search" />

      <!-- GitHub -->
      {
        githubLink && (
          <a
            href={githubLink.href}
            target="_blank"
            rel="noopener noreferrer"
            class="marketing-github-link"
            aria-label="GitHub repository"
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
            </svg>
          </a>
        )
      }

      <!-- Theme switcher -->
      <button
        class="marketing-theme-toggle"
        data-theme-toggle
        aria-label="Toggle dark/light mode"
      >
        <!-- Sun icon (shown in dark mode) -->
        <svg class="theme-icon-sun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5" />
          <line x1="12" y1="1" x2="12" y2="3" />
          <line x1="12" y1="21" x2="12" y2="23" />
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
          <line x1="1" y1="12" x2="3" y2="12" />
          <line x1="21" y1="12" x2="23" y2="12" />
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
        </svg>
        <!-- Moon icon (shown in light mode) -->
        <svg class="theme-icon-moon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
        </svg>
      </button>

      <!-- Docs button -->
      <a href="/docs/getting-started/overview/" class="marketing-docs-btn">
        Docs
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
          <path d="M1 6h10M7 2l4 4-4 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </a>

      <!-- Mobile hamburger -->
      <button
        class="marketing-hamburger"
        data-hamburger
        aria-label="Toggle menu"
        aria-expanded="false"
      >
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
      </button>
    </div>
  </div>

  <!-- Mobile nav -->
  <div class="marketing-mobile-nav" data-mobile-nav>
    <ul class="mobile-nav-list">
      {
        navItems.map((item: any) => (
          <li class="mobile-nav-item">
            {item.megaMenu ? (
              <>
                <button class="mobile-nav-link mobile-accordion-trigger" data-mobile-accordion>
                  {item.name}
                  <svg class="chevron-icon" width="12" height="12" viewBox="0 0 10 10" fill="none">
                    <path d="M2 4l3 3 3-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                </button>
                <ul class="mobile-accordion-panel">
                  {item.children.map((child: any) => (
                    <li>
                      <a href={child.url} class="mobile-accordion-link">
                        {child.name}
                      </a>
                    </li>
                  ))}
                  <li>
                    <a href="/features/" class="mobile-accordion-link mobile-accordion-all">
                      View All Features
                    </a>
                  </li>
                </ul>
              </>
            ) : (
              <a href={item.url} class={`mobile-nav-link ${currentPath === item.url ? "active" : ""}`}>
                {item.name}
              </a>
            )}
          </li>
        ))
      }
      <li class="mobile-nav-item mobile-nav-cta">
        <a href="/docs/getting-started/overview/" class="marketing-docs-btn mobile">
          Docs
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
            <path d="M1 6h10M7 2l4 4-4 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </a>
      </li>
    </ul>
  </div>
</header>

<style>
  /* ── Header container ── */
  .marketing-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    transition: background-color 0.3s ease, backdrop-filter 0.3s ease;
  }

  .marketing-header.scrolled {
    background: color-mix(in srgb, var(--color-body, #0d0d0d) 85%, transparent);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-bottom: 1px solid color-mix(in srgb, var(--color-light, #f6f6f6) 6%, transparent);
  }

  :root[data-theme="light"] .marketing-header.scrolled {
    background: color-mix(in srgb, var(--color-lightmode-body, #fff) 90%, transparent);
    border-bottom-color: color-mix(in srgb, var(--color-lightmode-light, #181818) 8%, transparent);
  }

  .marketing-header-inner {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    padding: 0.875rem 1.5rem;
    gap: 0.5rem;
  }

  /* ── Logo ── */
  .marketing-logo {
    display: flex;
    align-items: center;
    text-decoration: none;
    flex-shrink: 0;
  }

  .marketing-logo img {
    height: 28px;
    width: auto;
  }

  .logo-light {
    display: none;
  }

  :root[data-theme="light"] .logo-dark {
    display: none;
  }

  :root[data-theme="light"] .logo-light {
    display: block;
  }

  /* ── Desktop nav ── */
  .marketing-nav {
    display: none;
  }

  @media (min-width: 1024px) {
    .marketing-nav {
      display: flex;
      align-items: center;
      margin-right: auto;
    }
  }

  .marketing-nav-list {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .marketing-nav-item {
    position: relative;
  }

  .marketing-nav-link {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: color-mix(in srgb, var(--color-light, #f6f6f6) 75%, transparent);
    text-decoration: none;
    border: none;
    background: none;
    cursor: pointer;
    border-radius: 0.5rem;
    transition: color 0.15s ease, background-color 0.15s ease;
    white-space: nowrap;
    font-family: inherit;
  }

  .marketing-nav-link:hover,
  .marketing-nav-link.active {
    color: var(--color-light, #f6f6f6);
    background: color-mix(in srgb, var(--color-light, #f6f6f6) 6%, transparent);
  }

  :root[data-theme="light"] .marketing-nav-link {
    color: color-mix(in srgb, var(--color-lightmode-light, #181818) 70%, transparent);
  }

  :root[data-theme="light"] .marketing-nav-link:hover,
  :root[data-theme="light"] .marketing-nav-link.active {
    color: var(--color-lightmode-light, #181818);
    background: color-mix(in srgb, var(--color-lightmode-light, #181818) 6%, transparent);
  }

  .chevron-icon {
    transition: transform 0.2s ease;
  }

  .has-mega-menu:hover .chevron-icon,
  .marketing-nav-link[aria-expanded="true"] .chevron-icon {
    transform: rotate(180deg);
  }

  /* Show mega menu on hover (desktop) */
  @media (min-width: 1024px) {
    .has-mega-menu:hover :global(.mega-menu),
    .marketing-nav-link[aria-expanded="true"] + :global(.mega-menu) {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }
  }

  /* ── Right actions ── */
  .marketing-header-actions {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .marketing-github-link {
    display: flex;
    align-items: center;
    justify-content: center;
    color: color-mix(in srgb, var(--color-light, #f6f6f6) 60%, transparent);
    transition: color 0.15s ease;
    text-decoration: none;
    padding: 0.375rem;
    border-radius: 0.375rem;
  }

  .marketing-github-link:hover {
    color: var(--color-light, #f6f6f6);
  }

  :root[data-theme="light"] .marketing-github-link {
    color: color-mix(in srgb, var(--color-lightmode-light, #181818) 60%, transparent);
  }

  :root[data-theme="light"] .marketing-github-link:hover {
    color: var(--color-lightmode-light, #181818);
  }

  /* ── Theme toggle ── */
  .marketing-theme-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.375rem;
    border: none;
    background: none;
    cursor: pointer;
    color: color-mix(in srgb, var(--color-light, #f6f6f6) 60%, transparent);
    border-radius: 0.375rem;
    transition: color 0.15s ease;
  }

  .marketing-theme-toggle:hover {
    color: var(--color-light, #f6f6f6);
  }

  :root[data-theme="light"] .marketing-theme-toggle {
    color: color-mix(in srgb, var(--color-lightmode-light, #181818) 60%, transparent);
  }

  :root[data-theme="light"] .marketing-theme-toggle:hover {
    color: var(--color-lightmode-light, #181818);
  }

  /* Show correct icon per theme */
  .theme-icon-moon {
    display: none;
  }

  :root[data-theme="light"] .theme-icon-sun {
    display: none;
  }

  :root[data-theme="light"] .theme-icon-moon {
    display: block;
  }

  /* ── Docs button ── */
  .marketing-docs-btn {
    display: none;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 1rem;
    font-size: 0.8125rem;
    font-weight: 600;
    color: #fff;
    background: var(--color-primary-gradient);
    border-radius: 0.5rem;
    text-decoration: none;
    transition: transform 0.15s ease, filter 0.15s ease;
    white-space: nowrap;
  }

  .marketing-docs-btn:hover {
    transform: scale(1.03);
    filter: brightness(1.1);
  }

  @media (min-width: 1024px) {
    .marketing-docs-btn {
      display: flex;
    }
  }

  .marketing-docs-btn.mobile {
    display: flex;
    width: fit-content;
  }

  /* ── Hamburger ── */
  .marketing-hamburger {
    display: flex;
    flex-direction: column;
    gap: 4px;
    padding: 0.5rem;
    background: none;
    border: none;
    cursor: pointer;
  }

  @media (min-width: 1024px) {
    .marketing-hamburger {
      display: none;
    }
  }

  .hamburger-line {
    display: block;
    width: 20px;
    height: 2px;
    background: var(--color-light, #f6f6f6);
    border-radius: 1px;
    transition: transform 0.25s ease, opacity 0.25s ease;
  }

  :root[data-theme="light"] .hamburger-line {
    background: var(--color-lightmode-light, #181818);
  }

  .marketing-hamburger[aria-expanded="true"] .hamburger-line:nth-child(1) {
    transform: translateY(6px) rotate(45deg);
  }

  .marketing-hamburger[aria-expanded="true"] .hamburger-line:nth-child(2) {
    opacity: 0;
  }

  .marketing-hamburger[aria-expanded="true"] .hamburger-line:nth-child(3) {
    transform: translateY(-6px) rotate(-45deg);
  }

  /* ── Mobile nav ── */
  .marketing-mobile-nav {
    display: none;
    padding: 1rem 1.5rem 1.5rem;
    border-top: 1px solid color-mix(in srgb, var(--color-light, #f6f6f6) 6%, transparent);
  }

  :root[data-theme="light"] .marketing-mobile-nav {
    border-top-color: color-mix(in srgb, var(--color-lightmode-light, #181818) 8%, transparent);
  }

  .marketing-mobile-nav.is-open {
    display: block;
  }

  @media (min-width: 1024px) {
    .marketing-mobile-nav {
      display: none !important;
    }
  }

  .mobile-nav-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .mobile-nav-link {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 0.5rem;
    font-size: 1rem;
    font-weight: 500;
    color: color-mix(in srgb, var(--color-light, #f6f6f6) 80%, transparent);
    text-decoration: none;
    border: none;
    background: none;
    cursor: pointer;
    width: 100%;
    text-align: left;
    font-family: inherit;
    border-radius: 0.5rem;
    transition: color 0.15s ease, background-color 0.15s ease;
  }

  .mobile-nav-link:hover,
  .mobile-nav-link.active {
    color: var(--color-light, #f6f6f6);
    background: color-mix(in srgb, var(--color-light, #f6f6f6) 6%, transparent);
  }

  :root[data-theme="light"] .mobile-nav-link {
    color: color-mix(in srgb, var(--color-lightmode-light, #181818) 75%, transparent);
  }

  :root[data-theme="light"] .mobile-nav-link:hover,
  :root[data-theme="light"] .mobile-nav-link.active {
    color: var(--color-lightmode-light, #181818);
    background: color-mix(in srgb, var(--color-lightmode-light, #181818) 6%, transparent);
  }

  .mobile-accordion-panel {
    list-style: none;
    padding: 0 0 0 1rem;
    margin: 0;
    display: none;
  }

  .mobile-accordion-panel.is-open {
    display: block;
  }

  .mobile-accordion-trigger .chevron-icon {
    transition: transform 0.2s ease;
  }

  .mobile-accordion-trigger[aria-expanded="true"] .chevron-icon {
    transform: rotate(180deg);
  }

  .mobile-accordion-link {
    display: block;
    padding: 0.5rem 0.75rem;
    font-size: 0.9rem;
    font-weight: 400;
    color: color-mix(in srgb, var(--color-light, #f6f6f6) 65%, transparent);
    text-decoration: none;
    border-radius: 0.375rem;
    transition: color 0.15s ease, background-color 0.15s ease;
  }

  .mobile-accordion-link:hover {
    color: var(--color-light, #f6f6f6);
    background: color-mix(in srgb, var(--color-light, #f6f6f6) 4%, transparent);
  }

  :root[data-theme="light"] .mobile-accordion-link {
    color: color-mix(in srgb, var(--color-lightmode-light, #181818) 60%, transparent);
  }

  :root[data-theme="light"] .mobile-accordion-link:hover {
    color: var(--color-lightmode-light, #181818);
    background: color-mix(in srgb, var(--color-lightmode-light, #181818) 4%, transparent);
  }

  .mobile-accordion-all {
    color: var(--color-primary, #5CA3CA);
    font-weight: 500;
  }

  .mobile-nav-cta {
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid color-mix(in srgb, var(--color-light, #f6f6f6) 6%, transparent);
  }

  :root[data-theme="light"] .mobile-nav-cta {
    border-top-color: color-mix(in srgb, var(--color-lightmode-light, #181818) 8%, transparent);
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const header = document.querySelector("[data-header]") as HTMLElement;
    const hamburger = document.querySelector("[data-hamburger]") as HTMLButtonElement;
    const mobileNav = document.querySelector("[data-mobile-nav]") as HTMLElement;
    const themeToggle = document.querySelector("[data-theme-toggle]") as HTMLButtonElement;
    const megaTriggers = document.querySelectorAll("[data-mega-trigger]");
    const mobileAccordions = document.querySelectorAll("[data-mobile-accordion]");

    // Sticky header on scroll
    const onScroll = () => {
      if (window.scrollY > 20) {
        header?.classList.add("scrolled");
      } else {
        header?.classList.remove("scrolled");
      }
    };
    window.addEventListener("scroll", onScroll, { passive: true });
    onScroll();

    // Hamburger toggle
    hamburger?.addEventListener("click", () => {
      const isOpen = hamburger.getAttribute("aria-expanded") === "true";
      hamburger.setAttribute("aria-expanded", String(!isOpen));
      mobileNav?.classList.toggle("is-open");
    });

    // Theme toggle
    themeToggle?.addEventListener("click", () => {
      const html = document.documentElement;
      const current = html.getAttribute("data-theme");
      const next = current === "dark" ? "light" : "dark";
      html.setAttribute("data-theme", next);
      html.classList.toggle("dark", next === "dark");
      localStorage.setItem("starlight-theme", next);
    });

    // Mega menu triggers (desktop click/hover is handled in CSS; this handles aria)
    megaTriggers.forEach((trigger) => {
      trigger.addEventListener("click", (e) => {
        // On mobile, prevent default
        if (window.innerWidth < 1024) {
          e.preventDefault();
        }
        const expanded = trigger.getAttribute("aria-expanded") === "true";
        // Close all other mega menus
        megaTriggers.forEach((t) => {
          if (t !== trigger) t.setAttribute("aria-expanded", "false");
        });
        trigger.setAttribute("aria-expanded", String(!expanded));
        const megaMenu = trigger.querySelector("[data-mega-menu]");
        megaMenu?.classList.toggle("is-open");
      });
    });

    // Close mega menu on outside click
    document.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;
      if (!target.closest(".has-mega-menu")) {
        megaTriggers.forEach((t) => {
          t.setAttribute("aria-expanded", "false");
          t.querySelector("[data-mega-menu]")?.classList.remove("is-open");
        });
      }
    });

    // Mobile accordion
    mobileAccordions.forEach((btn) => {
      btn.addEventListener("click", () => {
        const expanded = btn.getAttribute("aria-expanded") === "true";
        btn.setAttribute("aria-expanded", String(!expanded));
        const panel = btn.nextElementSibling;
        panel?.classList.toggle("is-open");
      });
    });
  });
</script>
