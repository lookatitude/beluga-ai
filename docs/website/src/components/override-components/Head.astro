---
import { AstroFont } from "astro-font";
import theme from "@/config/theme.json";

const route = Astro.locals.starlightRoute;
const { head } = route;

// Page metadata from Starlight route
const pageTitle = route.entry.data.title;
const pageDescription = route.entry.data.description || `${pageTitle} â€” Beluga AI documentation`;
const siteTitle = route.siteTitle;
const pageLang = route.lang || "en";

// Build canonical URL
const canonicalURL = new URL(Astro.url.pathname, Astro.site || "https://beluga-ai.dev");

// Dynamic OG image: frontmatter override > auto-generated > fallback
const customOgImage = (route.entry.data as Record<string, unknown>).ogImage as string | undefined;
const ogSlug = Astro.url.pathname.replace(/^\/|\/$/g, "") || "index";
const defaultOgPath = `/og/${ogSlug === "" ? "index" : ogSlug}.png`;
const ogImageURL = customOgImage
  ? new URL(customOgImage, Astro.site || "https://beluga-ai.dev").href
  : new URL(defaultOgPath, Astro.site || "https://beluga-ai.dev").href;

// Build breadcrumb items from URL path
const pathSegments = Astro.url.pathname.split("/").filter(Boolean);
const breadcrumbItems = [
  { name: "Home", url: new URL("/", Astro.site || "https://beluga-ai.dev").href },
  ...pathSegments.map((segment, i) => ({
    name: segment
      .split("-")
      .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
      .join(" "),
    url: new URL(
      "/" + pathSegments.slice(0, i + 1).join("/") + "/",
      Astro.site || "https://beluga-ai.dev"
    ).href,
  })),
];

const breadcrumbJsonLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: breadcrumbItems.map((item, i) => ({
    "@type": "ListItem",
    position: i + 1,
    name: item.name,
    item: item.url,
  })),
};

// Contextual article schema based on URL pattern
const isSplash = route.entry.data.template === "splash";
const pathname = Astro.url.pathname;
const isTutorial = pathname.startsWith("/tutorials/");
const isApiRef = pathname.startsWith("/api-reference/");
const customSchemaType = (route.entry.data as Record<string, unknown>).schemaType as string | undefined;

function getArticleType(): string {
  if (isSplash) return "WebPage";
  if (customSchemaType === "faq") return "FAQPage";
  if (isTutorial) return "HowTo";
  if (isApiRef) return "TechArticle";
  return "TechArticle";
}

const articleType = getArticleType();
const articleJsonLd: Record<string, unknown> = {
  "@context": "https://schema.org",
  "@type": articleType,
  headline: pageTitle,
  description: pageDescription,
  url: canonicalURL.href,
  author: {
    "@type": "Organization",
    name: "Lookatitude",
    url: "https://lookatitude.com",
  },
  publisher: {
    "@type": "Organization",
    name: "Lookatitude",
    url: "https://lookatitude.com",
    logo: {
      "@type": "ImageObject",
      url: ogImageURL,
    },
  },
  image: ogImageURL,
  inLanguage: pageLang,
  ...(route.lastUpdated && { dateModified: route.lastUpdated.toISOString() }),
};

// Add HowTo-specific fields for tutorials
if (articleType === "HowTo") {
  articleJsonLd.step = [
    {
      "@type": "HowToStep",
      name: pageTitle,
      text: pageDescription,
      url: canonicalURL.href,
    },
  ];
}

// WebSite schema with SearchAction (global, for sitelinks search box)
const siteUrl = (Astro.site || new URL("https://beluga-ai.dev")).href;
const webSiteJsonLd = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  name: "Beluga AI",
  url: siteUrl,
  potentialAction: {
    "@type": "SearchAction",
    target: {
      "@type": "EntryPoint",
      urlTemplate: `${siteUrl}?q={search_term_string}`,
    },
    "query-input": "required name=search_term_string",
  },
};

// Organization schema (homepage only)
const organizationJsonLd = isSplash
  ? {
      "@context": "https://schema.org",
      "@type": "Organization",
      name: "Lookatitude",
      url: "https://lookatitude.com",
      logo: ogImageURL,
      sameAs: ["https://github.com/lookatitude"],
    }
  : null;

// SoftwareApplication schema (homepage only)
const softwareJsonLd = isSplash
  ? {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      name: "Beluga AI",
      applicationCategory: "DeveloperApplication",
      operatingSystem: "Cross-platform",
      programmingLanguage: "Go",
      description:
        "Go-native agentic AI framework with streaming-first design, 22+ LLM providers, RAG, voice AI, and enterprise-grade infrastructure.",
      url: siteUrl,
      author: {
        "@type": "Organization",
        name: "Lookatitude",
        url: "https://lookatitude.com",
      },
      license: "https://opensource.org/licenses/MIT",
    }
  : null;

// Check for keywords in frontmatter (custom extended schema)
const keywords = (route.entry.data as Record<string, unknown>).keywords as string | undefined;

// font families
const pf = theme.fonts.font_family.primary;
// @ts-ignore
const sf = theme.fonts.font_family.secondary ;

let fontPrimary, fontSecondary;
if (theme.fonts.font_family.primary) {
  fontPrimary = theme.fonts.font_family.primary
    .replace(/\+/g, " ")
    .replace(/:[ital,]*[ital@]*[wght@]*[0-9,;.]+/gi, "");
}
// @ts-ignore
if (theme.fonts.font_family.secondary) {
// @ts-ignore
  fontSecondary = theme.fonts.font_family.secondary
    .replace(/\+/g, " ")
    .replace(/:[ital,]*[ital@]*[wght@]*[0-9,;.]+/gi, "");
}

---

{head.map(({ tag: Tag, attrs, content }) => <Tag {...attrs} set:html={content} />)}

<!-- Open Graph (og:title, og:type, og:url, og:description, og:locale, og:site_name provided by Starlight) -->
<meta property="og:image" content={ogImageURL} />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:image:type" content="image/png" />

<!-- OG type: website for homepage, article for doc pages -->
<meta property="og:type" content={isSplash ? "website" : "article"} />

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content={`${pageTitle} | ${siteTitle}`} />
<meta name="twitter:description" content={pageDescription} />
<meta name="twitter:image" content={ogImageURL} />

<!-- Author -->
<meta name="author" content="Lookatitude" />

<!-- Keywords (if provided in frontmatter) -->
{keywords && <meta name="keywords" content={keywords} />}

<!-- hreflang (Starlight adds these only when multilingual; we add for single-locale sites) -->
<link rel="alternate" hreflang="en" href={canonicalURL.href} />
<link rel="alternate" hreflang="x-default" href={canonicalURL.href} />

<!-- JSON-LD Structured Data: BreadcrumbList -->
<script type="application/ld+json" set:html={JSON.stringify(breadcrumbJsonLd)} />

<!-- JSON-LD Structured Data: Article/WebPage -->
<script type="application/ld+json" set:html={JSON.stringify(articleJsonLd)} />

<!-- JSON-LD Structured Data: WebSite -->
<script type="application/ld+json" set:html={JSON.stringify(webSiteJsonLd)} />

<!-- JSON-LD Structured Data: Organization (homepage only) -->
{organizationJsonLd && (
  <script type="application/ld+json" set:html={JSON.stringify(organizationJsonLd)} />
)}

<!-- JSON-LD Structured Data: SoftwareApplication (homepage only) -->
{softwareJsonLd && (
  <script type="application/ld+json" set:html={JSON.stringify(softwareJsonLd)} />
)}

<!-- Preconnect to Google Fonts for faster font loading -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

<!-- google font css -->
    <AstroFont
      config={[
        {
          src: [],
          preload: false,
          display: "swap",
          name: fontPrimary!,
          fallback: "sans-serif",
          cssVariable: "font-primary",
          googleFontsURL: `https://fonts.googleapis.com/css2?family=${pf}&display=swap`,
        },
        {
          src: [],
          preload: false,
          display: "swap",
          name: fontSecondary!,
          fallback: "sans-serif",
          cssVariable: "font-secondary",
          googleFontsURL: `https://fonts.googleapis.com/css2?family=${sf}&display=swap`,
        },
      ]}
    />

<script>
  import mermaid from "mermaid";
  mermaid.initialize({ startOnLoad: true });
</script>
